<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-RAG | Dashboard</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-dark: #1e293b;
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main); 
            display: flex; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 300px;
            background: var(--panel-dark);
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        .sidebar h2 { font-size: 1.25rem; margin-top: 0; color: var(--accent); }
        .sidebar p { font-size: 0.875rem; color: var(--text-dim); line-height: 1.5; }

        .upload-zone {
            margin-top: 2rem;
            padding: 1.5rem;
            border: 2px dashed #475569;
            border-radius: 12px;
            text-align: center;
            transition: 0.3s;
        }
        .upload-zone:hover { border-color: var(--accent); }
        
        #fileInput { display: none; }
        .upload-btn {
            display: inline-block;
            background: var(--accent);
            color: var(--bg-dark);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        /* Main Content Styling */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }

        .visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            gap: 4px;
            margin-bottom: 2rem;
        }
        .bar { width: 6px; height: 10px; background: var(--accent); border-radius: 3px; transition: 0.1s; }

        #status { font-size: 1rem; color: var(--text-dim); margin-bottom: 2rem; height: 1.5rem; font-weight: 500; }
        
        #startBtn {
            background: var(--accent);
            color: var(--bg-dark);
            border: none;
            padding: 1.25rem 2.5rem;
            border-radius: 50px;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
        }
        #startBtn.active { background: var(--danger); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }

        #transcript {
            margin-top: 3rem;
            width: 100%;
            max-width: 600px;
            background: rgba(30, 41, 59, 0.5);
            padding: 1.5rem;
            border-radius: 16px;
            height: 250px; /* Increased height for history */
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.6;
            border: 1px solid #334155;
            text-align: left; /* Left align for chat style */
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .msg { padding: 0.5rem 1rem; border-radius: 12px; max-width: 85%; }
        .msg-bot { background: #334155; align-self: flex-start; color: var(--accent); }
        .msg-user { background: var(--accent); align-self: flex-end; color: var(--bg-dark); }

        .upload-status { font-size: 0.75rem; margin-top: 1rem; color: var(--accent); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Voice-RAG</h2>
        <p>Your intelligent voice companion powered by AWS Nova Sonic and ChromaDB.</p>
        
        <div class="upload-zone">
            <p>Add knowledge to the agent</p>
            <label for="fileInput" class="upload-btn">Select PDF / Text</label>
            <input type="file" id="fileInput" accept=".pdf,.txt">
            <div id="uploadStatus" class="upload-status"></div>
        </div>

        <div style="margin-top: auto; font-size: 0.75rem; color: var(--text-dim);">
            Connection: <span id="connStatus" style="color: var(--danger)">Disconnected</span>
        </div>
    </div>

    <div class="main-content">
        <div class="visualizer" id="visualizer"></div>
        <div id="status">Ready to start conversation</div>
        
        <button id="startBtn">Start Conversation</button>

        <div id="transcript">
            <div class="msg msg-bot">Waiting for your signal...</div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const connStatus = document.getElementById('connStatus');
        const transcript = document.getElementById('transcript');
        const visualizer = document.getElementById('visualizer');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        
        // Helper to add chat messages
        function addMessage(text, role) {
            // Find or create current active bot message if streaming
            let msgDiv;
            if (role === 'bot' && transcript.lastElementChild?.classList.contains('msg-bot-active')) {
                msgDiv = transcript.lastElementChild;
            } else {
                msgDiv = document.createElement('div');
                msgDiv.className = `msg ${role === 'bot' ? 'msg-bot msg-bot-active' : 'msg-user'}`;
                transcript.appendChild(msgDiv);
            }
            msgDiv.innerText = (role === 'bot' ? "Bot: " : "You: ") + text;
            transcript.scrollTop = transcript.scrollHeight;
            return msgDiv;
        }

        // Create visualizer bars
        for(let i=0; i<30; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            visualizer.appendChild(bar);
        }

        // File Ingestion Logic
        fileInput.onchange = async () => {
            const file = fileInput.files[0];
            if (!file) return;

            uploadStatus.innerText = "Ingesting " + file.name + "...";
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/ingest', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'success') {
                    uploadStatus.style.color = 'var(--success)';
                    uploadStatus.innerText = "Success! " + data.chunks_ingested + " chunks added.";
                } else {
                    throw new Error("Ingestion failed");
                }
            } catch (err) {
                uploadStatus.style.color = 'var(--danger)';
                uploadStatus.innerText = "Error: " + err.message;
            }
        };

        // Voice WebSocket Logic
        let ws;
        let audioCtx;
        let nextStartTime = 0;

        startBtn.onclick = async () => {
            if (ws) {
                location.reload();
                return;
            }

            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                ws = new WebSocket(`ws://${location.host}/ws`);
                ws.binaryType = "arraybuffer";

                ws.onopen = () => {
                    status.innerText = "Listening...";
                    connStatus.innerText = "Connected";
                    connStatus.style.color = "var(--success)";
                    startBtn.innerText = "End Session";
                    startBtn.classList.add('active');
                    startRecording(stream);
                };

                ws.onmessage = async (e) => {
                    if (typeof e.data === 'string') {
                        const data = JSON.parse(e.data);
                        if (data.event?.textOutput) {
                            addMessage(data.event.textOutput.content, 'bot');
                            status.innerText = "Assistant is speaking...";
                        } else if (data.event?.userTranscript) {
                            // Finalize any active bot message before user speaks
                            document.querySelectorAll('.msg-bot-active').forEach(m => m.classList.remove('msg-bot-active'));
                            addMessage(data.event.userTranscript, 'user');
                        } else if (data.event?.statusUpdate) {
                            status.innerText = data.event.statusUpdate;
                        }
                    } else {
                        playOutputAudio(e.data);
                    }
                };

                ws.onclose = () => {
                    connStatus.innerText = "Disconnected";
                    connStatus.style.color = "var(--danger)";
                    status.innerText = "Session Ended";
                    startBtn.disabled = true;
                };

            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
            }
        };

        function startRecording(stream) {
            const source = audioCtx.createMediaStreamSource(stream);
            const processor = audioCtx.createScriptProcessor(512, 1, 1);
            source.connect(processor);
            processor.connect(audioCtx.destination);

            const bars = document.querySelectorAll('.bar');
            processor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);
                const vol = inputData.reduce((a, b) => a + Math.abs(b), 0) / 512;
                bars.forEach((b, i) => {
                    const h = 10 + (vol * 400 * Math.sin(i / 5 + Date.now() / 100));
                    b.style.height = Math.max(10, h) + 'px';
                });

                const output = new Int16Array(inputData.length);
                for (let i = 0; i < inputData.length; i++) {
                    output[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7FFF;
                }
                if (ws.readyState === WebSocket.OPEN) ws.send(output.buffer);
            };
        }

        const playbackCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
        function playOutputAudio(arrayBuffer) {
            const int16 = new Int16Array(arrayBuffer);
            const float32 = new Float32Array(int16.length);
            for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 0x7FFF;

            const buffer = playbackCtx.createBuffer(1, float32.length, 24000);
            buffer.getChannelData(0).set(float32);
            const source = playbackCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(playbackCtx.destination);

            const currentTime = playbackCtx.currentTime;
            if (nextStartTime < currentTime) nextStartTime = currentTime + 0.05;
            source.start(nextStartTime);
            nextStartTime += buffer.duration;
        }
    </script>
</body>
</html>
